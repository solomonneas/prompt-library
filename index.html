<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,900;1,400&family=Source+Serif+4:opsz,wght@8..60,300;8..60,400;8..60,600;8..60,700&family=Space+Grotesk:wght@300;400;500;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Syne:wght@400;500;600;700;800&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;0,9..144,700;0,9..144,900;1,9..144,400&family=Outfit:wght@200;300;400;500;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    :root { --anim-dur: 0.35s; --anim-ease: cubic-bezier(0.22, 1, 0.36, 1); }

    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scroll-thumb, #555); border-radius: 3px; }

    /* Shared transitions */
    .card-enter { animation: cardIn var(--anim-dur) var(--anim-ease) both; }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(16px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .fade-in { animation: fadeIn 0.5s ease both; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .slide-up { animation: slideUp 0.4s var(--anim-ease) both; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stagger-1 { animation-delay: 0.05s; }
    .stagger-2 { animation-delay: 0.1s; }
    .stagger-3 { animation-delay: 0.15s; }
    .stagger-4 { animation-delay: 0.2s; }
    .stagger-5 { animation-delay: 0.25s; }
    .stagger-6 { animation-delay: 0.3s; }

    /* Modal backdrop */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 90;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .modal-content {
      position: relative; z-index: 91; max-height: 90vh; overflow-y: auto;
      animation: slideUp 0.3s var(--anim-ease);
    }

    /* Copy flash */
    .copy-flash { animation: copyPulse 0.6s ease; }
    @keyframes copyPulse {
      0% { transform: scale(1); }
      30% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    /* Variable highlighting */
    .var-highlight {
      display: inline;
      padding: 1px 5px;
      border-radius: 4px;
      font-weight: 600;
    }

    /* Toast */
    #toast {
      position: fixed; bottom: 24px; right: 24px; z-index: 200;
      padding: 12px 20px; border-radius: 8px;
      font-size: 14px; font-weight: 500;
      transform: translateY(80px); opacity: 0;
      transition: all 0.3s var(--anim-ease);
      pointer-events: none;
    }
    #toast.show { transform: translateY(0); opacity: 1; }

    /* ═══════════════════════════════════════════════════════════════════
       VARIANT 1: Soft Dark — warm amber accents on charcoal
       Font: Space Grotesk + Crimson Pro
       ═══════════════════════════════════════════════════════════════════ */
    .v1 {
      --bg: #1a1816; --bg2: #242220; --bg3: #2e2b28;
      --text: #e8e0d6; --text2: #b8ad9e; --text3: #8a7e72;
      --accent: #e8a849; --accent2: #d4903a; --accent-soft: rgba(232,168,73,0.12);
      --border: #3a3632; --border2: #4a4540;
      --card: #222018; --card-hover: #2a2720;
      --danger: #d45a5a; --success: #6abf7b;
      --scroll-thumb: #4a4540;
      --var-bg: rgba(232,168,73,0.15); --var-text: #e8a849;
      --tag-bg: rgba(232,168,73,0.1); --tag-text: #d4903a; --tag-border: rgba(232,168,73,0.2);
      --toast-bg: #2e2b28; --toast-text: #e8e0d6; --toast-border: #e8a849;
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .v1 .font-display { font-family: 'Crimson Pro', serif; }
    .v1 .hero-title { font-family: 'Crimson Pro', serif; font-weight: 300; font-size: 2.5rem; letter-spacing: -0.02em; }
    .v1 .cat-pill { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); }
    .v1 .cat-pill.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .v1 .prompt-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
    .v1 .prompt-card:hover { background: var(--card-hover); border-color: var(--border2); }
    .v1 .search-box { background: var(--bg2); border: 1px solid var(--border); color: var(--text); }
    .v1 .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .v1 .modal-panel { background: var(--bg2); border: 1px solid var(--border2); border-radius: 16px; }
    .v1 .btn-primary { background: var(--accent); color: #1a1816; font-weight: 600; }
    .v1 .btn-primary:hover { background: var(--accent2); }
    .v1 .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text2); }
    .v1 .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .v1 .stats-bar { background: var(--bg2); border-bottom: 1px solid var(--border); }

    /* ═══════════════════════════════════════════════════════════════════
       VARIANT 2: Clean Editorial — magazine-style with sharp typography
       Font: Playfair Display + DM Sans
       ═══════════════════════════════════════════════════════════════════ */
    .v2 {
      --bg: #faf8f5; --bg2: #f0ece6; --bg3: #e6e0d8;
      --text: #1a1612; --text2: #5a5248; --text3: #8a8278;
      --accent: #c0392b; --accent2: #a93226; --accent-soft: rgba(192,57,43,0.08);
      --border: #e0d8ce; --border2: #d0c8be;
      --card: #ffffff; --card-hover: #fdfcfa;
      --danger: #c0392b; --success: #27ae60;
      --scroll-thumb: #c8c0b8;
      --var-bg: rgba(192,57,43,0.08); --var-text: #c0392b;
      --tag-bg: #f0ece6; --tag-text: #5a5248; --tag-border: #e0d8ce;
      --toast-bg: #1a1612; --toast-text: #faf8f5; --toast-border: #c0392b;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .v2 .font-display { font-family: 'Playfair Display', serif; }
    .v2 .hero-title { font-family: 'Playfair Display', serif; font-weight: 900; font-size: 3rem; letter-spacing: -0.03em; font-style: italic; }
    .v2 .cat-pill { background: var(--card); border: 1px solid var(--border); color: var(--text2); font-weight: 500; }
    .v2 .cat-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .v2 .prompt-card { background: var(--card); border: 1px solid var(--border); border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .v2 .prompt-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .v2 .search-box { background: var(--card); border: 2px solid var(--border); color: var(--text); border-radius: 0; }
    .v2 .search-box:focus { border-color: var(--accent); box-shadow: none; }
    .v2 .modal-panel { background: var(--card); border: 2px solid var(--text); border-radius: 0; }
    .v2 .btn-primary { background: var(--text); color: var(--bg); font-weight: 600; border-radius: 0; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.8rem; }
    .v2 .btn-primary:hover { background: var(--accent); }
    .v2 .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text2); border-radius: 0; }
    .v2 .btn-ghost:hover { border-color: var(--text); color: var(--text); }
    .v2 .stats-bar { background: var(--card); border-bottom: 2px solid var(--text); }

    /* ═══════════════════════════════════════════════════════════════════
       VARIANT 3: Warm Earthy — terracotta, sage, cream
       Font: Fraunces + Outfit
       ═══════════════════════════════════════════════════════════════════ */
    .v3 {
      --bg: #f5efe6; --bg2: #ebe3d6; --bg3: #ddd4c4;
      --text: #2c2418; --text2: #5c4e3e; --text3: #8a7a66;
      --accent: #c4654a; --accent2: #b05840; --accent-soft: rgba(196,101,74,0.1);
      --border: #d8cebe; --border2: #c8b8a4;
      --card: #faf6f0; --card-hover: #f8f2ea;
      --danger: #c4654a; --success: #6b8f5e;
      --scroll-thumb: #c8b8a4;
      --var-bg: rgba(107,143,94,0.12); --var-text: #5a7a4e;
      --tag-bg: rgba(196,101,74,0.08); --tag-text: #c4654a; --tag-border: rgba(196,101,74,0.2);
      --toast-bg: #2c2418; --toast-text: #f5efe6; --toast-border: #c4654a;
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .v3 .font-display { font-family: 'Fraunces', serif; }
    .v3 .hero-title { font-family: 'Fraunces', serif; font-weight: 900; font-size: 2.8rem; letter-spacing: -0.02em; font-style: normal; }
    .v3 .cat-pill { background: var(--bg2); border: 1px solid var(--border); color: var(--text2); border-radius: 99px; }
    .v3 .cat-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; }
    .v3 .prompt-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; }
    .v3 .prompt-card:hover { border-color: var(--accent); box-shadow: 0 2px 16px rgba(196,101,74,0.08); }
    .v3 .search-box { background: var(--card); border: 1px solid var(--border); color: var(--text); border-radius: 99px; padding-left: 20px; }
    .v3 .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .v3 .modal-panel { background: var(--card); border: 1px solid var(--border); border-radius: 20px; }
    .v3 .btn-primary { background: var(--accent); color: #fff; font-weight: 600; border-radius: 99px; }
    .v3 .btn-primary:hover { background: var(--accent2); }
    .v3 .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text2); border-radius: 99px; }
    .v3 .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .v3 .stats-bar { background: var(--bg2); border-bottom: 1px solid var(--border); border-radius: 12px; margin: 0 16px; }

    /* ═══════════════════════════════════════════════════════════════════
       VARIANT 4: Cool Frosted — icy blues, glass morphism
       Font: Syne + Source Serif 4
       ═══════════════════════════════════════════════════════════════════ */
    .v4 {
      --bg: #0f1318; --bg2: #161b22; --bg3: #1e2530;
      --text: #e2e8f0; --text2: #94a3b8; --text3: #64748b;
      --accent: #60a5fa; --accent2: #3b82f6; --accent-soft: rgba(96,165,250,0.1);
      --border: rgba(148,163,184,0.15); --border2: rgba(148,163,184,0.25);
      --card: rgba(30,37,48,0.6); --card-hover: rgba(30,37,48,0.8);
      --danger: #f87171; --success: #4ade80;
      --scroll-thumb: #334155;
      --var-bg: rgba(96,165,250,0.12); --var-text: #60a5fa;
      --tag-bg: rgba(96,165,250,0.08); --tag-text: #60a5fa; --tag-border: rgba(96,165,250,0.2);
      --toast-bg: rgba(30,37,48,0.95); --toast-text: #e2e8f0; --toast-border: #60a5fa;
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .v4 .font-display { font-family: 'Source Serif 4', serif; }
    .v4 .hero-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 2.6rem; letter-spacing: -0.03em; text-transform: uppercase; }
    .v4 .cat-pill { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text2); backdrop-filter: blur(8px); }
    .v4 .cat-pill.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .v4 .prompt-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; backdrop-filter: blur(12px); }
    .v4 .prompt-card:hover { background: var(--card-hover); border-color: var(--border2); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .v4 .search-box { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text); backdrop-filter: blur(8px); }
    .v4 .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-soft); }
    .v4 .modal-panel { background: rgba(22,27,34,0.95); border: 1px solid var(--border2); border-radius: 16px; backdrop-filter: blur(20px); }
    .v4 .btn-primary { background: var(--accent); color: #0f1318; font-weight: 700; }
    .v4 .btn-primary:hover { background: var(--accent2); }
    .v4 .btn-ghost { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text2); }
    .v4 .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .v4 .stats-bar { background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); backdrop-filter: blur(8px); }

    /* ═══════════════════════════════════════════════════════════════════
       VARIANT 5: Luxury Refined — deep plum, gold, parchment
       Font: Cormorant Garamond + Libre Baskerville
       ═══════════════════════════════════════════════════════════════════ */
    .v5 {
      --bg: #12080e; --bg2: #1a0e16; --bg3: #251820;
      --text: #ede4d8; --text2: #b8a898; --text3: #887868;
      --accent: #d4a44a; --accent2: #c49440; --accent-soft: rgba(212,164,74,0.1);
      --border: #352830; --border2: #453840;
      --card: #1e1018; --card-hover: #261820;
      --danger: #d45a6a; --success: #6abf7b;
      --scroll-thumb: #453840;
      --var-bg: rgba(212,164,74,0.12); --var-text: #d4a44a;
      --tag-bg: rgba(212,164,74,0.06); --tag-text: #d4a44a; --tag-border: rgba(212,164,74,0.15);
      --toast-bg: #251820; --toast-text: #ede4d8; --toast-border: #d4a44a;
      font-family: 'Libre Baskerville', serif;
      background: var(--bg);
      color: var(--text);
    }
    .v5 .font-display { font-family: 'Cormorant Garamond', serif; }
    .v5 .hero-title { font-family: 'Cormorant Garamond', serif; font-weight: 300; font-size: 3.2rem; letter-spacing: 0.04em; }
    .v5 .cat-pill { background: rgba(212,164,74,0.04); border: 1px solid var(--border); color: var(--text3); letter-spacing: 0.06em; text-transform: uppercase; font-size: 0.7rem; }
    .v5 .cat-pill.active { background: rgba(212,164,74,0.1); border-color: var(--accent); color: var(--accent); }
    .v5 .prompt-card { background: var(--card); border: 1px solid var(--border); border-radius: 4px; }
    .v5 .prompt-card:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(212,164,74,0.05); }
    .v5 .search-box { background: var(--bg2); border: 1px solid var(--border); color: var(--text); letter-spacing: 0.02em; }
    .v5 .search-box:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-soft); }
    .v5 .modal-panel { background: var(--bg2); border: 1px solid var(--accent); border-radius: 4px; }
    .v5 .btn-primary { background: var(--accent); color: #12080e; font-weight: 700; border-radius: 2px; letter-spacing: 0.06em; text-transform: uppercase; font-size: 0.75rem; }
    .v5 .btn-primary:hover { background: var(--accent2); }
    .v5 .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text3); border-radius: 2px; text-transform: uppercase; letter-spacing: 0.06em; font-size: 0.75rem; }
    .v5 .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
    .v5 .stats-bar { background: var(--bg2); border-bottom: 1px solid var(--border); }

    /* Prompt content pre formatting */
    .prompt-content {
      white-space: pre-wrap; word-break: break-word;
      line-height: 1.7; font-size: 0.9rem;
    }
    .prompt-content code {
      padding: 2px 6px; border-radius: 4px;
      font-size: 0.85em;
    }
    .v1 .prompt-content code, .v4 .prompt-content code, .v5 .prompt-content code {
      background: rgba(255,255,255,0.06); color: var(--text);
    }
    .v2 .prompt-content code, .v3 .prompt-content code {
      background: rgba(0,0,0,0.05); color: var(--text);
    }

    /* Variant indicator */
    .variant-indicator {
      position: fixed; bottom: 24px; left: 24px; z-index: 100;
      display: flex; gap: 6px;
    }
    .variant-dot {
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid var(--text3); cursor: pointer;
      transition: all 0.2s ease;
    }
    .variant-dot.active { background: var(--accent); border-color: var(--accent); transform: scale(1.3); }

    /* Background decorations per variant */
    .v1::before {
      content: ''; position: fixed; top: -50%; right: -20%; width: 80%; height: 100%;
      background: radial-gradient(ellipse, rgba(232,168,73,0.03) 0%, transparent 60%);
      pointer-events: none; z-index: 0;
    }
    .v4::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(96,165,250,0.06) 0%, transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(139,92,246,0.04) 0%, transparent 40%);
      pointer-events: none; z-index: 0;
    }
    .v5::before {
      content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background:
        radial-gradient(ellipse at 30% 0%, rgba(212,164,74,0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 100%, rgba(140,60,90,0.04) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
    }

    /* Mode toggle switch */
    .mode-switch { position: relative; width: 44px; height: 24px; cursor: pointer; }
    .mode-switch input { display: none; }
    .mode-track {
      position: absolute; inset: 0; border-radius: 99px;
      background: var(--bg3); border: 1px solid var(--border);
      transition: background 0.2s;
    }
    .mode-switch input:checked + .mode-track { background: var(--accent-soft); border-color: var(--accent); }
    .mode-knob {
      position: absolute; top: 3px; left: 3px; width: 16px; height: 16px;
      border-radius: 50%; background: var(--text3);
      transition: all 0.2s ease;
    }
    .mode-switch input:checked ~ .mode-knob { left: 23px; background: var(--accent); }

    /* Input fields */
    .field-input {
      width: 100%; padding: 10px 14px; font-size: 0.9rem;
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); outline: none; transition: border-color 0.2s;
    }
    .field-input:focus { border-color: var(--accent); }
    .v2 .field-input { border-radius: 0; }
    .v3 .field-input { border-radius: 12px; }
    .v5 .field-input { border-radius: 2px; }

    textarea.field-input { resize: vertical; min-height: 120px; font-family: 'Space Grotesk', monospace; }

    /* Category icons mapping via data attribute */
    [data-cat-color="Build"] { --cat: #3b82f6; }
    [data-cat-color="Review"] { --cat: #f59e0b; }
    [data-cat-color="System"] { --cat: #8b5cf6; }
    [data-cat-color="Design"] { --cat: #ec4899; }
    [data-cat-color="Pipeline"] { --cat: #10b981; }
    [data-cat-color="Custom"] { --cat: #6366f1; }

    /* Responsive */
    @media (max-width: 768px) {
      .hero-title { font-size: 1.8rem !important; }
      .prompt-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast"></div>

  <script>
    // ═══════════════════════════════════════════════════════════════════════
    // STATE & CONFIG
    // ═══════════════════════════════════════════════════════════════════════

    const hostname = window.location.hostname || 'localhost';
    const API_BASE = `http://${hostname}:8005`;

    const CATEGORY_META = {
      Build:    { icon: 'hammer',       color: '#3b82f6' },
      Review:   { icon: 'scan-search',  color: '#f59e0b' },
      System:   { icon: 'settings-2',   color: '#8b5cf6' },
      Design:   { icon: 'palette',      color: '#ec4899' },
      Pipeline: { icon: 'git-branch',   color: '#10b981' },
      Custom:   { icon: 'sparkles',     color: '#6366f1' },
    };

    // Demo prompts (built-in fallback)
    const DEMO_PROMPTS = {
      prompts: [
        {
          id: 'demo-1', title: 'Dev Tool Build Template',
          content: 'BUILD: {{project_name}}\n\nStack: Single index.html file with Tailwind CDN + Lucide CDN + Google Fonts.\nPort: {{port}}\nLocation: /home/clawdbot/.openclaw/workspace/pipeline/work/{{slug}}/index.html\n\nRequirements:\n- 5 visual variants switchable with keyboard shortcuts (1-5)\n- Each variant: distinct color palette, unique typography, different spatial feel\n- NO green-on-black terminal themes\n- Demo mode with mock data + Live mode connected to API\n- Keyboard shortcuts: 1-5 variants, / search, Escape close, ? help\n- Responsive design\n- Copy-to-clipboard functionality where applicable\n\nDesign Rules:\n- NO generic fonts (Inter, Roboto, Arial, system fonts)\n- Bold aesthetic directions, each variant feels like a different designer\n- Animations for page load, micro-interactions\n- CSS variables for theme consistency\n- Generous negative space OR controlled density',
          category: 'Build', tags: ['frontend', 'dev-tool', 'single-file', 'tailwind'],
          description: 'Standard template for building single-file dev tools with 5 visual variants',
          variables: ['project_name', 'port', 'slug'],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        },
        {
          id: 'demo-2', title: 'Frontend Design Rules (FRONTEND_DESIGN.md)',
          content: 'No AI Slop. Every UI should be exceptional, not generic.\n\nFIVE DESIGN VARIANTS for every frontend project (/1 through /5).\n\nDesign Thinking — before coding, commit to a BOLD aesthetic direction:\n- Purpose: What problem does this interface solve?\n- Tone: Pick an extreme — brutally minimal, maximalist chaos, retro-futuristic, luxury/refined\n- Differentiation: What makes this UNFORGETTABLE?\n\nTypography: Distinctive fonts only. Pair display + body fonts. NO Inter/Roboto/Arial.\nColor: CSS variables. Dominant colors with sharp accents > timid palettes.\nMotion: High-impact moments — staggered page load reveals.\n\nANTI-PATTERNS (NEVER):\n- Generic system fonts\n- Cliched purple gradients on white\n- Predictable layouts\n- Same aesthetic across variants',
          category: 'Design', tags: ['design', 'aesthetics', 'variants', 'anti-patterns'],
          description: 'Master design rules for all frontend projects — the anti-slop manifesto',
          variables: [],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        },
        {
          id: 'demo-3', title: 'GPT 5.2 Code Review',
          content: 'Review this codebase for quality, correctness, and maintainability.\n\nFocus areas:\n1. **Security**: XSS, injection, path traversal, unsafe evals, hardcoded secrets\n2. **Performance**: Unnecessary re-renders, memory leaks, O(n²) loops, missing debounce\n3. **Code Quality**: Dead code, duplicated logic, unclear naming, missing error handling\n4. **Architecture**: Separation of concerns, component boundaries, state management patterns\n5. **Accessibility**: Missing aria labels, keyboard navigation, color contrast\n\nOutput format:\n- **Critical** (must fix): Security issues, bugs, data loss risks\n- **Important** (should fix): Performance problems, maintainability issues\n- **Suggestions** (nice to have): Style improvements, minor refactors\n- **Positive** (keep doing): Well-written patterns worth preserving\n\nBe specific. Reference file paths and line numbers. Suggest fixes, not just problems.',
          category: 'Review', tags: ['review', 'code-quality', 'gpt', 'pipeline'],
          description: 'Code review prompt used for GPT 5.2 review pass in the build pipeline',
          variables: [],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        },
        {
          id: 'demo-4', title: 'Pipeline Build Workflow',
          content: 'Optimized Pipeline (2026-02-08):\n\n1. **Opus PRD/Research** — Architecture, planning, scoping\n2. **Opus Build** — Sub-agent builds the project\n3. **GPT 5.2 Code Review** — Sub-agent reviews the build output\n4. **PR + CodeRabbit** — Open PR on GitHub, CodeRabbit auto-reviews\n5. **Single Opus Polish** — Synthesizes findings and applies fixes\n6. **Push** — Merge and push to main\n\nRules:\n- ONE Anthropic sub-agent at a time (shared TPM bucket)\n- No network commands in sub-agents\n- Commit from main after each sub-agent completes\n- Conventional commits (feat:, fix:, chore:)\n- Never mention AI/Claude/Anthropic in commits',
          category: 'Pipeline', tags: ['pipeline', 'workflow', 'build-process', 'sub-agents'],
          description: 'The optimized build pipeline for new projects',
          variables: [],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        },
        {
          id: 'demo-5', title: 'Sub-Agent Spawn Template',
          content: 'BUILD: {{project_name}}\n\n## What You\'re Building\n{{description}}\n\n## Port & Location\n- Frontend: {{location}}\n- Port: {{port}}\n\n## Stack\n{{stack_details}}\n\n## Requirements\n{{requirements}}\n\n## Design Rules\nFollow FRONTEND_DESIGN.md principles:\n- 5 visual variants, keyboard switchable (1-5)\n- NO generic fonts, NO AI slop\n- Bold aesthetic directions per variant\n- Responsive, accessible, performant\n\n## Git Rules\n- Conventional commits only\n- Never mention AI/Claude in commits',
          category: 'System', tags: ['sub-agent', 'sessions-spawn', 'delegation'],
          description: 'Template for spawning sub-agent build tasks',
          variables: ['project_name', 'description', 'location', 'port', 'stack_details', 'requirements'],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        },
        {
          id: 'demo-6', title: 'Post-Build Obsidian Note',
          content: '---\ntitle: "{{project_name}} — Build Notes"\ndate: {{date}}\ntags: [build, {{category}}, {{tags}}]\n---\n\n# {{project_name}}\n\n## What It Does\n{{description}}\n\n## Stack\n{{stack}}\n\n## Key Design Decisions\n{{decisions}}\n\n## Variants (if applicable)\n{{variants}}\n\n## Gotchas & Lessons\n{{gotchas}}\n\n## Port & Access\n- Dev server: `http://192.168.4.86:{{port}}`\n- Location: `pipeline/work/{{slug}}/`\n\n## Status\n{{status}}',
          category: 'System', tags: ['documentation', 'obsidian', 'notes', 'post-build'],
          description: 'Template for post-build documentation notes uploaded to Cerebro',
          variables: ['project_name', 'date', 'category', 'tags', 'description', 'stack', 'decisions', 'variants', 'gotchas', 'port', 'slug', 'status'],
          createdAt: '2026-02-08T15:00:00.000Z', updatedAt: '2026-02-08T15:00:00.000Z'
        }
      ],
      categories: ['Build', 'Review', 'System', 'Design', 'Pipeline', 'Custom'],
      version: 1
    };

    const state = {
      variant: parseInt(localStorage.getItem('pl-variant') || '1'),
      mode: localStorage.getItem('pl-mode') || 'live', // 'live' or 'demo' (falls back to demo if API unreachable)
      prompts: [],
      categories: ['Build', 'Review', 'System', 'Design', 'Pipeline', 'Custom'],
      activeCategory: 'All',
      activeTag: null,
      searchQuery: '',
      expandedPrompt: null,
      editingPrompt: null,
      showHelp: false,
      showImport: false,
    };

    // ═══════════════════════════════════════════════════════════════════════
    // DATA LAYER
    // ═══════════════════════════════════════════════════════════════════════

    async function fetchPrompts() {
      if (state.mode === 'demo') {
        state.prompts = [...DEMO_PROMPTS.prompts];
        state.categories = [...DEMO_PROMPTS.categories];
        render();
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/prompts`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        state.prompts = data.prompts || [];
        state.categories = data.categories || state.categories;
        render();
      } catch (err) {
        toast(`Failed to connect to API: ${err.message}`, 'error');
        // Fallback to demo
        state.mode = 'demo';
        localStorage.setItem('pl-mode', 'demo');
        state.prompts = [...DEMO_PROMPTS.prompts];
        render();
      }
    }

    async function savePrompt(promptData) {
      if (state.mode === 'demo') {
        // Demo mode: save locally
        if (promptData.id) {
          const idx = state.prompts.findIndex(p => p.id === promptData.id);
          if (idx >= 0) {
            state.prompts[idx] = { ...state.prompts[idx], ...promptData, updatedAt: new Date().toISOString() };
          }
        } else {
          state.prompts.push({
            ...promptData,
            id: 'demo-' + Date.now(),
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        }
        render();
        toast('Prompt saved (demo mode)');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/prompts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(promptData)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        await fetchPrompts();
        toast('Prompt saved');
      } catch (err) {
        toast(`Save failed: ${err.message}`, 'error');
      }
    }

    async function deletePrompt(id) {
      if (state.mode === 'demo') {
        state.prompts = state.prompts.filter(p => p.id !== id);
        render();
        toast('Prompt deleted (demo mode)');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/prompts/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        await fetchPrompts();
        toast('Prompt deleted');
      } catch (err) {
        toast(`Delete failed: ${err.message}`, 'error');
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    // FILTERING & STATS
    // ═══════════════════════════════════════════════════════════════════════

    function getFilteredPrompts() {
      let filtered = [...state.prompts];
      if (state.activeCategory !== 'All') {
        filtered = filtered.filter(p => p.category === state.activeCategory);
      }
      if (state.activeTag) {
        filtered = filtered.filter(p => p.tags && p.tags.includes(state.activeTag));
      }
      if (state.searchQuery) {
        const q = state.searchQuery.toLowerCase();
        filtered = filtered.filter(p =>
          (p.title && p.title.toLowerCase().includes(q)) ||
          (p.description && p.description.toLowerCase().includes(q)) ||
          (p.content && p.content.toLowerCase().includes(q)) ||
          (p.tags && p.tags.some(t => t.toLowerCase().includes(q)))
        );
      }
      return filtered;
    }

    function getAllTags() {
      const tagMap = {};
      state.prompts.forEach(p => {
        (p.tags || []).forEach(t => { tagMap[t] = (tagMap[t] || 0) + 1; });
      });
      return Object.entries(tagMap).sort((a, b) => b[1] - a[1]);
    }

    function getCategoryCount(cat) {
      if (cat === 'All') return state.prompts.length;
      return state.prompts.filter(p => p.category === cat).length;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════

    function escapeHtml(str) {
      if (str == null) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function highlightVariables(text) {
      const escaped = escapeHtml(text);
      return escaped.replace(/\{\{(\w+)\}\}/g,
        '<span class="var-highlight" style="background:var(--var-bg);color:var(--var-text);">{{$1}}</span>'
      );
    }

    function highlightContent(text) {
      let html = escapeHtml(text);
      // Highlight {{variables}}
      html = html.replace(/\{\{(\w+)\}\}/g,
        '<span class="var-highlight" style="background:var(--var-bg);color:var(--var-text);">{{$1}}</span>'
      );
      // Bold **text**
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text);font-weight:700;">$1</strong>');
      // Inline code `text`
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      // Headers ## (at line start)
      html = html.replace(/^(#{1,3})\s+(.+)$/gm, (m, hashes, content) => {
        const level = hashes.length;
        const size = level === 1 ? '1.3em' : level === 2 ? '1.15em' : '1em';
        return `<span style="font-size:${size};font-weight:700;color:var(--accent);display:block;margin:8px 0 4px;">${content}</span>`;
      });
      return html;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        toast('Copied to clipboard');
      }).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('Copied to clipboard');
      });
    }

    function toast(msg, type = 'success') {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.background = type === 'error' ? 'var(--danger)' : 'var(--toast-bg)';
      el.style.color = type === 'error' ? '#fff' : 'var(--toast-text)';
      el.style.border = `1px solid ${type === 'error' ? 'var(--danger)' : 'var(--toast-border)'}`;
      el.classList.add('show');
      clearTimeout(el._timeout);
      el._timeout = setTimeout(() => el.classList.remove('show'), 2500);
    }

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function extractVariables(content) {
      const matches = content.match(/\{\{(\w+)\}\}/g);
      if (!matches) return [];
      return [...new Set(matches.map(m => m.replace(/[{}]/g, '')))];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // EXPORT / IMPORT
    // ═══════════════════════════════════════════════════════════════════════

    function exportLibrary() {
      const data = {
        prompts: state.prompts,
        categories: state.categories,
        version: 1,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prompt-library-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast('Library exported');
    }

    function importLibrary(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!data.prompts || !Array.isArray(data.prompts)) {
            throw new Error('Invalid format: missing prompts array');
          }
          state.prompts = data.prompts;
          if (data.categories) state.categories = data.categories;
          render();
          toast(`Imported ${data.prompts.length} prompts`);
        } catch (err) {
          toast(`Import failed: ${err.message}`, 'error');
        }
      };
      reader.readAsText(file);
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RENDER
    // ═══════════════════════════════════════════════════════════════════════

    function render() {
      const app = document.getElementById('app');
      const filtered = getFilteredPrompts();
      const allTags = getAllTags();

      app.className = `v${state.variant} min-h-screen relative`;

      app.innerHTML = `
        <!-- Stats Bar -->
        <div class="stats-bar px-6 py-3 flex items-center justify-between text-sm relative z-10">
          <div class="flex items-center gap-6">
            <span style="color:var(--text2)">
              <span style="color:var(--accent);font-weight:600">${state.prompts.length}</span> prompts
            </span>
            <span style="color:var(--text3)">·</span>
            <span style="color:var(--text2)">
              <span style="color:var(--accent);font-weight:600">${state.categories.length}</span> categories
            </span>
            <span style="color:var(--text3)">·</span>
            <span style="color:var(--text2)">
              <span style="color:var(--accent);font-weight:600">${allTags.length}</span> tags
            </span>
          </div>
          <div class="flex items-center gap-4">
            <!-- Mode Toggle -->
            <div class="flex items-center gap-2">
              <span style="color:var(--text3);font-size:0.8rem">${state.mode === 'demo' ? 'Demo' : 'Live'}</span>
              <label class="mode-switch">
                <input type="checkbox" ${state.mode === 'live' ? 'checked' : ''} onchange="toggleMode()">
                <div class="mode-track"></div>
                <div class="mode-knob"></div>
              </label>
            </div>
            <!-- Export/Import -->
            <button onclick="exportLibrary()" class="btn-ghost px-3 py-1 text-xs cursor-pointer flex items-center gap-1" title="Export JSON">
              <i data-lucide="download" style="width:14px;height:14px"></i>
              Export
            </button>
            <button onclick="document.getElementById('importInput').click()" class="btn-ghost px-3 py-1 text-xs cursor-pointer flex items-center gap-1" title="Import JSON">
              <i data-lucide="upload" style="width:14px;height:14px"></i>
              Import
            </button>
            <input type="file" id="importInput" accept=".json" style="display:none" onchange="if(this.files[0]) importLibrary(this.files[0])">
            <!-- Help -->
            <button onclick="state.showHelp=true;render()" class="btn-ghost px-2 py-1 text-xs cursor-pointer" title="Keyboard shortcuts (?)">
              <i data-lucide="keyboard" style="width:14px;height:14px"></i>
            </button>
          </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-6xl mx-auto px-6 pt-10 pb-20 relative z-10">
          <!-- Hero -->
          <div class="mb-10 slide-up">
            <h1 class="hero-title mb-3">Prompt Library</h1>
            <p style="color:var(--text2);max-width:520px;line-height:1.6" class="text-base">
              Browse, search, and manage your prompt templates. Copy with one click, edit in place, or export the entire collection.
            </p>
          </div>

          <!-- Search -->
          <div class="mb-8 slide-up stagger-1 relative">
            <div class="relative">
              <i data-lucide="search" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:var(--text3)"></i>
              <input
                id="searchInput"
                type="text"
                placeholder="Search prompts by title, content, tags..."
                class="search-box w-full py-3 pl-11 pr-4 text-sm outline-none transition-all rounded-lg"
                value="${escapeHtml(state.searchQuery)}"
                oninput="state.searchQuery=this.value;render()"
              >
              ${state.searchQuery ? `
                <button onclick="state.searchQuery='';render()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text3);cursor:pointer;background:none;border:none;">
                  <i data-lucide="x" style="width:16px;height:16px"></i>
                </button>
              ` : `
                <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:0.7rem;border:1px solid var(--border);padding:2px 6px;border-radius:4px;">/</span>
              `}
            </div>
          </div>

          <!-- Categories -->
          <div class="mb-6 slide-up stagger-2">
            <div class="flex flex-wrap gap-2 items-center">
              <button data-action="set-category" data-category="All"
                class="cat-pill px-4 py-2 text-sm cursor-pointer transition-all ${state.activeCategory === 'All' ? 'active' : ''}"
                style="border-radius:inherit;display:inline-flex;align-items:center;gap:6px;">
                <i data-lucide="layers" style="width:14px;height:14px"></i>
                All <span style="opacity:0.6;font-size:0.75rem">${state.prompts.length}</span>
              </button>
              ${state.categories.map(cat => {
                const meta = CATEGORY_META[cat] || CATEGORY_META.Custom;
                const count = getCategoryCount(cat);
                return `
                  <button data-action="set-category" data-category="${escapeHtml(cat)}"
                    class="cat-pill px-4 py-2 text-sm cursor-pointer transition-all ${state.activeCategory === cat ? 'active' : ''}"
                    data-cat-color="${cat}"
                    style="border-radius:inherit;display:inline-flex;align-items:center;gap:6px;">
                    <i data-lucide="${meta.icon}" style="width:14px;height:14px"></i>
                    ${cat} <span style="opacity:0.6;font-size:0.75rem">${count}</span>
                  </button>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Active Tag Filter -->
          ${state.activeTag ? `
            <div class="mb-4 flex items-center gap-2 slide-up" style="color:var(--text2);font-size:0.85rem;">
              <span>Filtering by tag:</span>
              <span style="background:var(--tag-bg);color:var(--tag-text);border:1px solid var(--tag-border);padding:2px 10px;border-radius:99px;font-size:0.8rem;">
                ${escapeHtml(state.activeTag)}
              </span>
              <button onclick="state.activeTag=null;render()" style="color:var(--text3);cursor:pointer;background:none;border:none;">
                <i data-lucide="x" style="width:14px;height:14px"></i>
              </button>
            </div>
          ` : ''}

          <!-- Tags Cloud (collapsible) -->
          ${allTags.length > 0 ? `
            <div class="mb-8 slide-up stagger-3">
              <div class="flex flex-wrap gap-1.5">
                ${allTags.slice(0, 20).map(([tag, count]) => `
                  <button data-action="toggle-tag" data-tag="${escapeHtml(tag)}"
                    style="background:${state.activeTag === tag ? 'var(--accent-soft)' : 'var(--tag-bg)'};
                           color:${state.activeTag === tag ? 'var(--accent)' : 'var(--tag-text)'};
                           border:1px solid ${state.activeTag === tag ? 'var(--accent)' : 'var(--tag-border)'};
                           padding:3px 10px;border-radius:99px;font-size:0.75rem;cursor:pointer;transition:all 0.15s;">
                    ${escapeHtml(tag)} <span style="opacity:0.5">${count}</span>
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}

          <!-- New Prompt Button -->
          <div class="mb-6 slide-up stagger-3">
            <button onclick="openEditor()" class="btn-primary px-5 py-2.5 text-sm cursor-pointer transition-all flex items-center gap-2" style="border-radius:inherit;border:none;">
              <i data-lucide="plus" style="width:16px;height:16px"></i>
              New Prompt
              <span style="opacity:0.5;font-size:0.7rem;margin-left:4px">N</span>
            </button>
          </div>

          <!-- Prompt Grid -->
          <div class="prompt-grid grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));">
            ${filtered.length === 0 ? `
              <div class="col-span-full text-center py-16" style="color:var(--text3)">
                <i data-lucide="file-search" style="width:48px;height:48px;margin:0 auto 12px;display:block;opacity:0.3"></i>
                <p class="text-lg mb-2">No prompts found</p>
                <p class="text-sm">Try adjusting your search or filters</p>
              </div>
            ` : filtered.map((prompt, i) => renderPromptCard(prompt, i)).join('')}
          </div>
        </div>

        <!-- Variant Indicator -->
        <div class="variant-indicator">
          ${[1,2,3,4,5].map(v => `
            <div class="variant-dot ${state.variant === v ? 'active' : ''}" onclick="switchVariant(${v})" title="Variant ${v}"></div>
          `).join('')}
        </div>

        <!-- Help Modal -->
        ${state.showHelp ? renderHelpModal() : ''}

        <!-- Edit Modal -->
        ${state.editingPrompt !== null ? renderEditModal() : ''}

        <!-- Expanded Prompt Modal -->
        ${state.expandedPrompt ? renderExpandedModal() : ''}
      `;

      // Initialize Lucide icons
      if (window.lucide) lucide.createIcons();

      // Re-focus search if it was focused
      const searchInput = document.getElementById('searchInput');
      if (searchInput && document.activeElement?.id === 'searchInput') {
        // Cursor position preservation
        const pos = searchInput.selectionStart;
        requestAnimationFrame(() => {
          searchInput.focus();
          searchInput.setSelectionRange(pos, pos);
        });
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RENDER COMPONENTS
    // ═══════════════════════════════════════════════════════════════════════

    function renderPromptCard(prompt, index) {
      const meta = CATEGORY_META[prompt.category] || CATEGORY_META.Custom;
      const hasVars = prompt.variables && prompt.variables.length > 0;
      const delay = Math.min(index, 8);
      const contentPreview = (prompt.content || '').slice(0, 140).replace(/\n/g, ' ');

      return `
        <div class="prompt-card p-5 cursor-pointer transition-all card-enter stagger-${delay % 6 + 1}"
             data-action="expand-prompt" data-id="${escapeHtml(prompt.id)}" style="position:relative;">
          <!-- Category Badge -->
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <span style="background:${meta.color}20;color:${meta.color};padding:3px 8px;border-radius:6px;font-size:0.7rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;">
                <i data-lucide="${meta.icon}" style="width:11px;height:11px"></i>
                ${prompt.category}
              </span>
              ${hasVars ? `
                <span style="color:var(--var-text);font-size:0.7rem;opacity:0.7;" title="${prompt.variables.length} variables">
                  <i data-lucide="variable" style="width:12px;height:12px;display:inline"></i>
                  ${prompt.variables.length}
                </span>
              ` : ''}
            </div>
            <div class="flex items-center gap-1" onclick="event.stopPropagation()">
              <button data-action="copy-prompt" data-id="${escapeHtml(prompt.id)}"
                class="btn-ghost p-1.5 cursor-pointer transition-all" style="border-radius:6px;border:none;" title="Copy content">
                <i data-lucide="copy" style="width:14px;height:14px"></i>
              </button>
              <button data-action="edit-prompt" data-id="${escapeHtml(prompt.id)}"
                class="btn-ghost p-1.5 cursor-pointer transition-all" style="border-radius:6px;border:none;" title="Edit">
                <i data-lucide="pencil" style="width:14px;height:14px"></i>
              </button>
            </div>
          </div>

          <!-- Title -->
          <h3 class="font-display text-lg font-semibold mb-1.5" style="color:var(--text);line-height:1.3;">
            ${escapeHtml(prompt.title)}
          </h3>

          <!-- Description -->
          ${prompt.description ? `
            <p style="color:var(--text2);font-size:0.85rem;line-height:1.5;margin-bottom:10px;">
              ${escapeHtml(prompt.description)}
            </p>
          ` : ''}

          <!-- Content Preview -->
          <div style="color:var(--text3);font-size:0.8rem;line-height:1.5;margin-bottom:12px;overflow:hidden;max-height:2.8em;">
            ${highlightVariables(contentPreview)}${(prompt.content || '').length > 140 ? '…' : ''}
          </div>

          <!-- Tags -->
          ${prompt.tags && prompt.tags.length > 0 ? `
            <div class="flex flex-wrap gap-1.5 mt-auto">
              ${prompt.tags.map(tag => `
                <span data-action="set-tag" data-tag="${escapeHtml(tag)}"
                  style="background:var(--tag-bg);color:var(--tag-text);border:1px solid var(--tag-border);padding:2px 8px;border-radius:99px;font-size:0.7rem;cursor:pointer;transition:all 0.15s;"
                  onmouseenter="this.style.borderColor='var(--accent)'"
                  onmouseleave="this.style.borderColor='var(--tag-border)'">
                  ${escapeHtml(tag)}
                </span>
              `).join('')}
            </div>
          ` : ''}

          <!-- Date -->
          <div style="color:var(--text3);font-size:0.7rem;margin-top:8px;">
            ${formatDate(prompt.updatedAt)}
          </div>
        </div>
      `;
    }

    function renderExpandedModal() {
      const prompt = state.prompts.find(p => p.id === state.expandedPrompt);
      if (!prompt) return '';
      const meta = CATEGORY_META[prompt.category] || CATEGORY_META.Custom;

      return `
        <div class="modal-backdrop" onclick="state.expandedPrompt=null;render()">
          <div class="modal-content modal-panel p-8 w-full max-w-3xl mx-4" role="dialog" aria-modal="true" aria-labelledby="expanded-title" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex items-start justify-between mb-6">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-3">
                  <span style="background:${meta.color}20;color:${meta.color};padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;">
                    <i data-lucide="${meta.icon}" style="width:12px;height:12px"></i>
                    ${prompt.category}
                  </span>
                  <span style="color:var(--text3);font-size:0.75rem">${formatDate(prompt.updatedAt)}</span>
                </div>
                <h2 id="expanded-title" class="font-display text-2xl font-bold" style="color:var(--text);line-height:1.3;">
                  ${escapeHtml(prompt.title)}
                </h2>
                ${prompt.description ? `
                  <p style="color:var(--text2);font-size:0.9rem;margin-top:6px;line-height:1.5;">
                    ${escapeHtml(prompt.description)}
                  </p>
                ` : ''}
              </div>
              <button onclick="state.expandedPrompt=null;render()" aria-label="Close" style="color:var(--text3);cursor:pointer;background:none;border:none;padding:4px;">
                <i data-lucide="x" style="width:20px;height:20px"></i>
              </button>
            </div>

            <!-- Tags -->
            ${prompt.tags && prompt.tags.length > 0 ? `
              <div class="flex flex-wrap gap-1.5 mb-5">
                ${prompt.tags.map(tag => `
                  <span style="background:var(--tag-bg);color:var(--tag-text);border:1px solid var(--tag-border);padding:3px 10px;border-radius:99px;font-size:0.75rem;">
                    ${escapeHtml(tag)}
                  </span>
                `).join('')}
              </div>
            ` : ''}

            <!-- Variables -->
            ${prompt.variables && prompt.variables.length > 0 ? `
              <div class="mb-5 p-4" style="background:var(--accent-soft);border:1px solid var(--border);border-radius:8px;">
                <div class="flex items-center gap-2 mb-2">
                  <i data-lucide="variable" style="width:14px;height:14px;color:var(--accent)"></i>
                  <span style="font-weight:600;font-size:0.85rem;color:var(--accent)">Variables</span>
                </div>
                <div class="flex flex-wrap gap-2">
                  ${prompt.variables.map(v => `
                    <span class="var-highlight" style="background:var(--var-bg);color:var(--var-text);padding:3px 10px;border-radius:6px;font-size:0.8rem;font-weight:600;">
                      {{${escapeHtml(v)}}}
                    </span>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            <!-- Content -->
            <div class="p-5 mb-5" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;max-height:50vh;overflow-y:auto;">
              <div class="prompt-content" style="color:var(--text2);">
                ${highlightContent(prompt.content)}
              </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button data-action="copy-prompt" data-id="${escapeHtml(prompt.id)}"
                  class="btn-primary px-4 py-2 text-sm cursor-pointer transition-all flex items-center gap-2" style="border:none;">
                  <i data-lucide="copy" style="width:14px;height:14px"></i>
                  Copy Content
                </button>
                <button data-action="edit-from-expanded" data-id="${escapeHtml(prompt.id)}"
                  class="btn-ghost px-4 py-2 text-sm cursor-pointer transition-all flex items-center gap-2">
                  <i data-lucide="pencil" style="width:14px;height:14px"></i>
                  Edit
                </button>
              </div>
              <button data-action="delete-prompt" data-id="${escapeHtml(prompt.id)}"
                class="btn-ghost px-3 py-2 text-sm cursor-pointer transition-all" style="color:var(--danger);border-color:var(--danger);">
                <i data-lucide="trash-2" style="width:14px;height:14px"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderEditModal() {
      const isNew = state.editingPrompt === 'new';
      const prompt = isNew ? {
        title: '', content: '', category: 'Custom', tags: [], description: '', variables: []
      } : state.prompts.find(p => p.id === state.editingPrompt);

      if (!prompt) return '';

      return `
        <div class="modal-backdrop" onclick="state.editingPrompt=null;render()">
          <div class="modal-content modal-panel p-8 w-full max-w-2xl mx-4" role="dialog" aria-modal="true" aria-labelledby="edit-title" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
              <h2 id="edit-title" class="font-display text-xl font-bold" style="color:var(--text)">
                ${isNew ? 'Create New Prompt' : 'Edit Prompt'}
              </h2>
              <button onclick="state.editingPrompt=null;render()" aria-label="Close" style="color:var(--text3);cursor:pointer;background:none;border:none;">
                <i data-lucide="x" style="width:20px;height:20px"></i>
              </button>
            </div>

            <form id="editForm" onsubmit="handleSave(event)">
              ${!isNew ? `<input type="hidden" name="id" value="${prompt.id}">` : ''}

              <!-- Title -->
              <div class="mb-4">
                <label style="color:var(--text2);font-size:0.8rem;font-weight:500;display:block;margin-bottom:4px;">Title *</label>
                <input type="text" name="title" value="${escapeHtml(prompt.title)}" required
                  class="field-input" placeholder="Prompt title...">
              </div>

              <!-- Description -->
              <div class="mb-4">
                <label style="color:var(--text2);font-size:0.8rem;font-weight:500;display:block;margin-bottom:4px;">Description</label>
                <input type="text" name="description" value="${escapeHtml(prompt.description || '')}"
                  class="field-input" placeholder="Brief description...">
              </div>

              <!-- Category -->
              <div class="mb-4">
                <label style="color:var(--text2);font-size:0.8rem;font-weight:500;display:block;margin-bottom:4px;">Category</label>
                <select name="category" class="field-input" style="cursor:pointer;">
                  ${state.categories.map(c => `
                    <option value="${c}" ${prompt.category === c ? 'selected' : ''}>${c}</option>
                  `).join('')}
                </select>
              </div>

              <!-- Tags -->
              <div class="mb-4">
                <label style="color:var(--text2);font-size:0.8rem;font-weight:500;display:block;margin-bottom:4px;">Tags (comma-separated)</label>
                <input type="text" name="tags" value="${(prompt.tags || []).join(', ')}"
                  class="field-input" placeholder="frontend, dev-tool, tailwind...">
              </div>

              <!-- Content -->
              <div class="mb-4">
                <label style="color:var(--text2);font-size:0.8rem;font-weight:500;display:block;margin-bottom:4px;">Content *</label>
                <textarea name="content" required class="field-input" style="min-height:200px;font-family:'Space Grotesk',monospace;font-size:0.85rem;line-height:1.6;" placeholder="Prompt content... Use {{variable}} for template variables">${escapeHtml(prompt.content)}</textarea>
              </div>

              <!-- Actions -->
              <div class="flex items-center justify-end gap-3 mt-6">
                <button type="button" onclick="state.editingPrompt=null;render()" class="btn-ghost px-5 py-2.5 text-sm cursor-pointer">
                  Cancel
                </button>
                <button type="submit" class="btn-primary px-5 py-2.5 text-sm cursor-pointer transition-all flex items-center gap-2" style="border:none;">
                  <i data-lucide="check" style="width:14px;height:14px"></i>
                  ${isNew ? 'Create Prompt' : 'Save Changes'}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    function renderHelpModal() {
      return `
        <div class="modal-backdrop" onclick="state.showHelp=false;render()">
          <div class="modal-content modal-panel p-8 w-full max-w-lg mx-4" role="dialog" aria-modal="true" aria-labelledby="help-title" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
              <h2 id="help-title" class="font-display text-xl font-bold" style="color:var(--text)">Keyboard Shortcuts</h2>
              <button onclick="state.showHelp=false;render()" aria-label="Close" style="color:var(--text3);cursor:pointer;background:none;border:none;">
                <i data-lucide="x" style="width:20px;height:20px"></i>
              </button>
            </div>

            <div class="space-y-3">
              ${[
                ['1 – 5', 'Switch visual variant'],
                ['/', 'Focus search'],
                ['N', 'New prompt'],
                ['Escape', 'Close modals & clear search'],
                ['?', 'Show this help'],
              ].map(([key, desc]) => `
                <div class="flex items-center justify-between py-2" style="border-bottom:1px solid var(--border);">
                  <span style="color:var(--text2);font-size:0.9rem">${desc}</span>
                  <kbd style="background:var(--bg3);color:var(--text);padding:3px 10px;border-radius:6px;font-size:0.8rem;font-weight:600;border:1px solid var(--border2);font-family:inherit;">
                    ${key}
                  </kbd>
                </div>
              `).join('')}
            </div>

            <div class="mt-8 p-4" style="background:var(--accent-soft);border:1px solid var(--border);border-radius:8px;">
              <p style="color:var(--text2);font-size:0.85rem;line-height:1.5;">
                <strong style="color:var(--accent)">Tip:</strong> Click any tag to filter. Click category pills to browse.
                In <strong>Demo mode</strong>, data is local. Switch to <strong>Live mode</strong> to sync with the API at <code style="font-size:0.8em">${API_BASE}</code>.
              </p>
            </div>
          </div>
        </div>
      `;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // EVENT HANDLERS
    // ═══════════════════════════════════════════════════════════════════════

    function switchVariant(v) {
      state.variant = v;
      localStorage.setItem('pl-variant', v);
      render();
    }

    function toggleMode() {
      state.mode = state.mode === 'demo' ? 'live' : 'demo';
      localStorage.setItem('pl-mode', state.mode);
      fetchPrompts();
    }

    function expandPrompt(id) {
      state.expandedPrompt = id;
      render();
    }

    function openEditor(id) {
      state.editingPrompt = id || 'new';
      state.expandedPrompt = null;
      render();
      // Focus title field
      requestAnimationFrame(() => {
        const titleInput = document.querySelector('input[name="title"]');
        if (titleInput) titleInput.focus();
      });
    }

    function handleSave(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        title: form.title.value.trim(),
        content: form.content.value.trim(),
        category: form.category.value,
        description: form.description.value.trim(),
        tags: form.tags.value.split(',').map(t => t.trim()).filter(Boolean),
      };

      // Auto-detect variables from content
      data.variables = extractVariables(data.content);

      // Include id if editing
      const idField = form.querySelector('input[name="id"]');
      if (idField) data.id = idField.value;

      savePrompt(data);
      state.editingPrompt = null;
      render();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // KEYBOARD SHORTCUTS
    // ═══════════════════════════════════════════════════════════════════════

    document.addEventListener('keydown', (e) => {
      // Don't intercept when typing in inputs
      const tag = (e.target.tagName || '').toLowerCase();
      const isInput = tag === 'input' || tag === 'textarea' || tag === 'select';

      if (e.key === 'Escape') {
        if (state.showHelp) { state.showHelp = false; render(); return; }
        if (state.editingPrompt !== null) { state.editingPrompt = null; render(); return; }
        if (state.expandedPrompt) { state.expandedPrompt = null; render(); return; }
        if (state.searchQuery) { state.searchQuery = ''; render(); return; }
        // Blur search
        document.activeElement?.blur();
        return;
      }

      if (isInput) return;

      if (e.key >= '1' && e.key <= '5') {
        switchVariant(parseInt(e.key));
        return;
      }
      if (e.key === '/') {
        e.preventDefault();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.focus();
        return;
      }
      if (e.key === 'n' || e.key === 'N') {
        openEditor();
        return;
      }
      if (e.key === '?') {
        state.showHelp = !state.showHelp;
        render();
        return;
      }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // EVENT DELEGATION (replaces inline onclick for injection safety)
    // ═══════════════════════════════════════════════════════════════════════

    document.addEventListener('click', (e) => {
      const el = e.target.closest('[data-action]');
      if (!el) return;
      const action = el.dataset.action;
      const id = el.dataset.id;

      switch (action) {
        case 'set-category':
          state.activeCategory = el.dataset.category;
          state.activeTag = null;
          render();
          break;
        case 'toggle-tag':
          state.activeTag = state.activeTag === el.dataset.tag ? null : el.dataset.tag;
          render();
          break;
        case 'set-tag':
          e.stopPropagation();
          state.activeTag = el.dataset.tag;
          render();
          break;
        case 'expand-prompt':
          expandPrompt(id);
          break;
        case 'copy-prompt': {
          e.stopPropagation();
          const prompt = state.prompts.find(p => p.id === id);
          if (prompt) {
            copyToClipboard(prompt.content);
            el.classList.add('copy-flash');
            setTimeout(() => el.classList.remove('copy-flash'), 600);
          }
          break;
        }
        case 'edit-prompt':
          e.stopPropagation();
          openEditor(id);
          break;
        case 'edit-from-expanded':
          state.expandedPrompt = null;
          openEditor(id);
          break;
        case 'delete-prompt':
          if (confirm('Delete this prompt?')) {
            deletePrompt(id);
            state.expandedPrompt = null;
          }
          break;
      }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════════════

    fetchPrompts();
  </script>
</body>
</html>
